{% extends 'profile/base.html' %}
{% block title %}Profile{% endblock %}
{% block header %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    function Capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
</script>
{% endblock %}

{% block content %}
<!-- User Stats -->
<div class="bg-hsl-20 rounded-lg flex flex-col">
    <!-- Header -->
    <div class="text-xl font-medium pl-5 py-2 bg-hsl-25 rounded-t-lg">
        <i class="fas fa-address-card mr-2 w-auto"></i>Stats
    </div>
    <!-- Content -->
    <div class="h-auto sm:h-64 flex flex-col sm:flex-row">
        <div class="m-2 sm:w-8/12 flex flex-col">
            <div class="flex flex-col sm:flex-row mx-4 justify-center">
                <!-- Rankings -->
                <div class="flex justify-center">
                    <div class="flex flex-col items-center">
                        <p class="text-sm">Global Ranking</p>
                        <p class="text-3xl font-medium -mt-1 text-hsl-90" id="global-ranking">
                            -
                        </p>
                    </div>
                    <div class="flex flex-col items-center ml-4">
                        <p class="text-sm">Country Ranking</p>
                        <p class="text-3xl font-medium -mt-1 text-hsl-90" id="country-ranking">
                            -
                        </p>
                    </div>
                </div>
                <!-- Grades -->
                <div class="grid grid-cols-5 grid-rows-1 mx-auto sm:ml-auto mt-2 sm:mt-0">
                    <div class="col-span-1 row-span-1 flex flex-col items-center mx-2">
                        <p class="text-3xl font-bold -mt-1 text-hsl-90 text-gray-300">SS</p>
                        <p class="text-sm">{{ stats['xh_count'] }}</p>
                    </div>
                    <div class="col-span-1 row-span-1 flex flex-col items-center mx-2">
                        <p class="text-3xl font-bold -mt-1 text-hsl-90 text-yellow-400">SS</p>
                        <p class="text-sm">{{ stats['x_count'] }}</p>
                    </div>
                    <div class="col-span-1 row-span-1 flex flex-col items-center mx-2">
                        <p class="text-3xl font-bold -mt-1 text-hsl-90 text-gray-300">S</p>
                        <p class="text-sm">{{ stats['sh_count'] }}</p>
                    </div>
                    <div class="col-span-1 row-span-1 flex flex-col items-center mx-2">
                        <p class="text-3xl font-bold -mt-1 text-hsl-90 text-yellow-400">S</p>
                        <p class="text-sm">{{ stats['s_count'] }}</p>
                    </div>
                    <div class="col-span-1 row-span-1 flex flex-col items-center mx-2">
                        <p class="text-3xl font-bold -mt-1 text-hsl-90 text-green-500">A</p>
                        <p class="text-sm">{{ stats['a_count'] }}</p>
                    </div>
                </div>
            </div>
            <!-- Graph -->
            <div class="flex h-24 sm:h-full items-center justify-center my-3 text-center">
                <p class="">We're currently collecting rank data, graph will be there soon! :D</p>
            </div>
        </div>
        <div class="hidden sm:flex mx-2 bg-hsl-10 h-56 my-auto w-0.5"></div>
        <!-- Stats -->
        <div class="flex sm:w-4/12 h-auto sm:h-32 mt-6 m-2">
            <div class="grid grid-cols-2 gap-1 gap-x-4 sm:gap-x-1 w-full h-full">
                <p class="col-span-1 row-span-1 font-medium text-sm text-hsl-80 flex justify-end sm:justify-start">
                    PP
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm text-hsl-90">
                    {{ stats['pp'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Accuracy
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['acc'] }}%
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Ranked Score
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['rscore'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Total Score
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['tscore'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Play Count
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['plays'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Playtime
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['playtime'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Total Hits
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['total_hits'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Max Combo
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['max_combo'] }}
                </p>
                <p class="col-span-1 row-span-1 font-medium text-sm flex justify-end sm:justify-start">
                    Replay Views
                </p>
                <p class="col-span-1 col-start-2 row-span-1 text-sm">
                    {{ stats['replay_views'] }}
                </p>
            </div>
        </div>
    </div>
</div>
{% if user['userpage_content'] != None %}
<!-- About Me -->
<div class="bg-hsl-20 rounded-lg flex flex-col my-3" style="min-height: 64px;">
    <!-- Header -->
    <div class="text-xl font-medium pl-5 py-2 bg-hsl-25 rounded-t-lg">
        <i class="fas fa-address-card mr-2 w-auto"></i>About Me
    </div>
    <!-- Content -->
    <div class="m-3 max-h-80 overflow-y-auto">
        {{user['userpage_content'] | safe}}
    </div>
</div>
{% endif %}
<!-- Top Plays -->
<div class="bg-hsl-20 rounded-lg flex flex-col my-3">
    <!-- Header -->
    <div class="text-xl font-medium pl-5 py-2 bg-hsl-25 rounded-t-lg">
        <i class="fas fa-trophy mr-2 w-auto"></i>Top Plays
    </div>
    <!-- Content -->
    <div class="m-3 overflow-x-scroll md:overflow-x-hidden" id="best">
    </div>
    <div class="flex content-center justify-center w-full pb-5">
        <button class="px-5 py-2 rounded bg-hsl-15 hover:bg-hsl-40 transform duration-200"
                onclick="get_best(cur_best)">
            Load More
        </button>
    </div>
</div>

<!-- Recent -->
<div class="bg-hsl-20 rounded-lg flex flex-col my-3">
    <!-- Header -->
    <div class="text-xl font-medium pl-5 py-2 bg-hsl-25 rounded-t-lg">
        <i class="fas fa-history mr-2 w-auto"></i>Recent Plays
    </div>
    <!-- Content -->
    <div class="m-3 overflow-x-scroll md:overflow-x-hidden" id="recent">
    </div>
    <div class="flex content-center justify-center w-full pb-5">
        <button class="px-5 py-2 rounded bg-hsl-15 hover:bg-hsl-40 transform duration-200"
                onclick="get_recent(cur_recent)">
            Load More
        </button>
    </div>
</div>

<!-- Most Played-->
<div class="bg-hsl-20 rounded-lg flex flex-col">
    <!-- Header -->
    <div class="text-xl font-medium pl-5 py-2 bg-hsl-25 rounded-t-lg">
        <i class="fas fa-play mr-2 w-auto"></i>Most Played
    </div>
    <!-- Content -->
    <div class="m-3 grid grid-cols-1 lg:grid-cols-2 gap-2" id="most-played">
    </div>
    <div class="flex content-center justify-center w-full pb-5">
        <button class="px-5 py-2 rounded bg-hsl-15 hover:bg-hsl-40 transform duration-200"
                onclick="get_most_played(cur_most_played)">
            Load More
        </button>
    </div>
</div>
{% endblock %}
{% block bottom %}
<script>
    // Display user id, this is not debug
    console.log("userid: {{ user['id'] }}")

    // Rank
    axios.get('https://api.{{ domain() }}/get_player_info?id={{ user["id"] }}&scope=all')
    .then((r) => {
        if (Number("{{mode}}") == 8) {
            var toget = 7
        } else {
            var toget = Number("{{ mode }}")
        }
        document.getElementById("country-ranking").innerHTML = "#" + r.data.player.stats[toget].country_rank
        document.getElementById("global-ranking").innerHTML = "#" + r.data.player.stats[toget].rank
    })
    function addCommas(x) {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }
    function rank_colors(rank) {
        switch (rank) {
            case 'XH':
                return 'text-gray-300'
            case 'X':
                return 'text-yellow-400'
            case 'SH':
                return 'text-gray-300'
            case 'S':
                return 'text-yellow-400'
            case 'A':
                return 'text-green-500'
            case 'B':
                return 'text-blue-500'
            case 'C':
                return 'text-purple-400'
            case 'D':
                return 'text-red-400'
            case 'F':
                return 'text-red-400'
    }}
    function grade_normal(rank) {
        switch (rank) {
            case 'XH':
                return 'SS'
            case 'X':
                return 'SS'
            case 'SH':
                return 'S'
            default:
                return rank
    }}
    // I copied this because timeago wasn't working ffs
    function timeSince(date) {

        var seconds = Math.floor((new Date() - date) / 1000);

        var interval = seconds / 31536000;

        if (interval > 1) {
          return Math.floor(interval) + " years";
        }
        interval = seconds / 2592000;
        if (interval > 1) {
          return Math.floor(interval) + " months";
        }
        interval = seconds / 86400;
        if (interval > 1) {
          return Math.floor(interval) + " days";
        }
        interval = seconds / 3600;
        if (interval > 1) {
          return Math.floor(interval) + " hours";
        }
        interval = seconds / 60;
        if (interval > 1) {
          return Math.floor(interval) + " minutes";
        }
        return Math.floor(seconds) + " seconds";
    }
    const numbermods = [
        {mod_text: "MR", mod_bit: 1 << 30},
        {mod_text: "V2", mod_bit: 1 << 29},
        {mod_text: "2K", mod_bit: 1 << 28},
        {mod_text: "3K", mod_bit: 1 << 27},
        {mod_text: "1K", mod_bit: 1 << 26},
        {mod_text: "KC", mod_bit: 1 << 25},
        {mod_text: "9K", mod_bit: 1 << 24},
        {mod_text: "TG", mod_bit: 1 << 23},
        {mod_text: "CN", mod_bit: 1 << 22},
        {mod_text: "RD", mod_bit: 1 << 21},
        {mod_text: "FI", mod_bit: 1 << 20},
        {mod_text: "8K", mod_bit: 1 << 19},
        {mod_text: "7K", mod_bit: 1 << 18},
        {mod_text: "6K", mod_bit: 1 << 17},
        {mod_text: "5K", mod_bit: 1 << 16},
        {mod_text: "4K", mod_bit: 1 << 15},
        {mod_text: "PF", mod_bit: 1 << 14},
        {mod_text: "AP", mod_bit: 1 << 13},
        {mod_text: "SO", mod_bit: 1 << 12},
        {mod_text: "AU", mod_bit: 1 << 11},
        {mod_text: "FL", mod_bit: 1 << 10},
        {mod_text: "NC", mod_bit: 1 << 9},
        {mod_text: "HT", mod_bit: 1 << 8},
        {mod_text: "RX", mod_bit: 1 << 7},
        {mod_text: "DT", mod_bit: 1 << 6},
        {mod_text: "SD", mod_bit: 1 << 5},
        {mod_text: "HR", mod_bit: 1 << 4},
        {mod_text: "HD", mod_bit: 1 << 3},
        {mod_text: "TD", mod_bit: 1 << 2},
        {mod_text: "EZ", mod_bit: 1 << 1},
        {mod_text: "NF", mod_bit: 1}
    ]
    function mods2str(mod) {
        let mod_text = '+'
        let mod_num = 0
        if (!isNaN(mod)) {
            mod_num = mod
            let bit = mod.toString(2)
            let fullbit = "0000000000000000000000000000000".substr(bit.length) + bit
            for (let i = 30; i >= 0; i--) {
                if (fullbit[i] == 1)  {
                    mod_text += numbermods[i].mod_text
                }
            }
        } else {
            mod = mod.toUpperCase()
            if (mod !== 'NM') {
                for (let i = 0; i < mod.length / 2; i++) {
                    let find_mod = numbermods.find(m => m.mod_text == mod.substr(i*2, 2))
                    mod_text += find_mod.mod_text
                    mod_num |= find_mod.mod_bit
                }
            }
        }
        if (mod_text.includes('NC') && mod_text.includes('DT')) mod_text = mod_text.replace('DT', '');
        if (mod_text.includes('PF') && mod_text.includes('SD')) mod_text = mod_text.replace('SD', '');
        if (mod_num == 0) mod_text = '';
        return {mod_text: mod_text, mod_num: mod_num}
    }

    cur_best = 4
    cur_recent = 4
    cur_most_played = 5
    best = document.getElementById("best")
    recent = document.getElementById("recent")
    most_played = document.getElementById("most-played")
    function get_best(n) {
        axios.get('https://api.{{ domain() }}/get_player_scores?scope=best&id={{ user["id"] }}&mode={{ mode }}&limit=' + Number(cur_best+1))
        .then((r) => {
            resp = r.data.scores.splice(cur_best-9, cur_best-4)
            for (el of resp) {
                timeago = new Date(el.play_time).getTime()
                best.innerHTML += `<div class="w-max md:w-full h-20 flex my-2">
                    <div class="w-auto sm:w-full h-full rounded-lg flex"
                         style="background: linear-gradient(hsl(var(--main), 10%, 10%, 0.70),
                         hsl(var(--main), 10%, 10%, 0.65)), url(https://assets.ppy.sh/beatmaps/${el.beatmap.set_id}/covers/cover.jpg);
                         background-position: center; background-size: cover">
                        <div class="w-auto md:w-full h-full grid grid-cols-12 grid-rows-1">
                            <!-- Map info -->
                            <div class="col-span-10 row-span-1 flex flex-col justify-center ml-2">
                                <p class="font-medium">
                                    <a  class="w-full text-hsl-80 hover:text-hsl-90 transform duration-200"
                                        href="/b/${el.beatmap.set_id}">
                                        <span class="text-ellipsis overflow-hidden">${el.beatmap.artist} - ${el.beatmap.title} [${el.beatmap.version}]</span>
                                    </a>
                                    <span class="ml-1">${mods2str(el.mods).mod_text}</span>
                                </p>
                                <div>
                                    <span>${addCommas(el.score)} / ${el.max_combo}x</span>
                                    <span class="ml-2 md:ml-3">${timeSince(timeago)} ago</span>
                                </div>
                            </div>
                            <!-- Score Info -->
                            <div class="col-span-2 row-span-2 grid grid-cols-3 grid-rows-1 gap-x-1 mr-3">
                                <div class="col-span-2 row-span-1 flex flex-col items-end justify-center mr-1">
                                    <span class="text-xl text-hsl-80 font-bold whitespace-nowrap">${Math.round(el.pp * 100)/100}pp</span>
                                    <span class="text-hsl-90 whitespace-nowrap">Acc ${Math.round(el.acc * 100)/100}%</span>
                                </div>
                                <div class="col-span-1 row-span-1 flex items-center justify-center">
                                    <span class="text-3xl font-bold ${rank_colors(el.grade)}">${grade_normal(el.grade)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center justify-items-center">
                        <div x-data="{ open: false }" @click.away="open = false" class="invisible w-0 sm:visible sm:w-auto block">
                            <!-- Dropdown toggle button -->
                            <button @click="open = true" class="flex items-center rounded-md pl-4 pr-2 py-2 pd-3.5 h-auto font-medium text-white hover:text-gray-300">
                                <i class="fas fa-ellipsis-v text-lg"></i>
                            </button>
                            <!-- Dropdown menu -->
                            <div x-show="open" x-transition:enter.duration.500ms x-transition:leave.duration.800ms
                                 class="absolute right-0 w-48 py-2 mt-5 bg-hsl-10 rounded-md shadow-xl">
                                <a href="/report/?id=${el.id}&type=score" class="block bg-hsl-10 hover:bg-hsl-20 px-4 py-2 text-sm text-gray-200 hover:text-hsl-70 border-l-2 border-transparent hover:border-hsl-60">
                                    Report Score
                                </a>
                                <a href="/score/${el.id}" class="block bg-hsl-10 hover:bg-hsl-20 px-4 py-2 text-sm text-gray-200 hover:text-hsl-70 border-l-2 border-transparent hover:border-hsl-60">
                                    View Score
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`
            }

        })

        cur_best = cur_best + 5
    }

    function get_recent(n) {
        axios.get('https://api.{{ domain() }}/get_player_scores?scope=recent&id={{ user["id"] }}&mode={{ mode }}&limit=' + Number(cur_best+1))
        .then((r) => {
            //why
            resp = r.data.scores.splice(cur_recent-9, cur_recent-4)
            for (el of resp) {
                timeago = new Date(el.play_time).getTime()
                recent.innerHTML += `<div class="w-max md:w-full h-20 flex my-2">
                    <div class="w-auto sm:w-full h-full rounded-lg flex"
                         style="background: linear-gradient(hsl(var(--main), 10%, 10%, 0.70),
                         hsl(var(--main), 10%, 10%, 0.65)), url(https://assets.ppy.sh/beatmaps/${el.beatmap.set_id}/covers/cover.jpg);
                         background-position: center; background-size: cover">
                        <div class="w-auto md:w-full h-full grid grid-cols-12 grid-rows-1">
                            <!-- Map info -->
                            <div class="col-span-10 row-span-1 flex flex-col justify-center ml-2">
                                <p class="font-medium">
                                    <a  class="w-full text-hsl-80 hover:text-hsl-90 transform duration-200"
                                        href="/b/${el.beatmap.set_id}">
                                        <span class="text-ellipsis overflow-hidden">${el.beatmap.artist} - ${el.beatmap.title} [${el.beatmap.version}]</span>
                                    </a>
                                    <span class="ml-1">${mods2str(el.mods).mod_text}</span>
                                </p>
                                <div>
                                    <span>${addCommas(el.score)} / ${el.max_combo}x</span>
                                    <span class="ml-2 md:ml-3">${timeSince(timeago)} ago</span>
                                </div>
                            </div>
                            <!-- Score Info -->
                            <div class="col-span-2 row-span-2 grid grid-cols-3 grid-rows-1 gap-x-1 mr-3">
                                <div class="col-span-2 row-span-1 flex flex-col items-end justify-center mr-1">
                                    <span class="text-xl text-hsl-80 font-bold whitespace-nowrap">${Math.round(el.pp * 100)/100}pp</span>
                                    <span class="text-hsl-90 whitespace-nowrap">Acc ${Math.round(el.acc * 100)/100}%</span>
                                </div>
                                <div class="col-span-1 row-span-1 flex items-center justify-center">
                                    <span class="text-3xl font-bold ${rank_colors(el.grade)}">${grade_normal(el.grade)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center justify-items-center">
                        <div x-data="{ open: false }" @click.away="open = false" class="invisible w-0 sm:visible sm:w-auto block">
                            <!-- Dropdown toggle button -->
                            <button @click="open = true" class="flex items-center rounded-md pl-4 pr-2 py-2 pd-3.5 h-auto font-medium text-white hover:text-gray-300">
                                <i class="fas fa-ellipsis-v text-lg"></i>
                            </button>
                            <!-- Dropdown menu -->
                            <div x-show="open" x-transition:enter.duration.500ms x-transition:leave.duration.800ms
                                 class="absolute right-0 w-48 py-2 mt-5 bg-hsl-10 rounded-md shadow-xl">
                                <a href="/report/?id=${el.id}&type=score" class="block bg-hsl-10 hover:bg-hsl-20 px-4 py-2 text-sm text-gray-200 hover:text-hsl-70 border-l-2 border-transparent hover:border-hsl-60">
                                    Report Score
                                </a>
                                <a href="/score/${el.id}" class="block bg-hsl-10 hover:bg-hsl-20 px-4 py-2 text-sm text-gray-200 hover:text-hsl-70 border-l-2 border-transparent hover:border-hsl-60">
                                    View Score
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`
            }

        })

        cur_recent = cur_recent + 5
    }

    function get_most_played(n) {
        axios.get('https://api.{{ domain() }}/get_player_most_played?id={{ user["id"] }}&mode={{ mode }}&limit=' + Number(cur_best+1))
        .then((r) => {
            //why
            resp = r.data.maps.splice(cur_most_played-10, cur_most_played-5)
            for (el of resp) {
                console.log(el)
                most_played.innerHTML += `
                <a  class="col-span-1 row-span-1 h-20 rounded-lg bg-hsl-30 flex
                    hover:bg-hsl-40 hover:opacity-60 transform duration-500"
                    style="background: linear-gradient(hsl(var(--main), 10%, 10%, 0.7),
                    hsl(var(--main), 10%, 10%, 0.7)), url(https://assets.ppy.sh/beatmaps/${el.set_id}/covers/cover.jpg);
                    background-position: center; background-size: cover"
                    href="/b/${el.set_id}">
                    <div class="grid grid-cols-6 grid-rows-1 gap-1 h-full w-full">
                        <div class="row-span-1 col-span-4 md:col-span-5 h-full flex justify-center ml-2 flex-col">
                            <p class="font-medium truncate">${el.artist} - ${el.title}</p>
                            <p class="mt-1 truncate">${el.version}</p>
                        </div>
                        <div class="row-span-1 col-span-2 md:col-span-1 flex items-end justify-end h-full">
                            <p class="font-medium text-sm md:text-base mr-2 mb-1 whitespace-nowrap">
                                Played <span class="text-hsl-80 text-base md:text-lg">${el.plays}x</span>
                            </p>
                        </div>
                    </div>
                </a>`
            }

        })

        cur_most_played = cur_most_played + 6
    }
    // Execute on load to get first 5 scores
    get_best(cur_best)
    get_recent(cur_recent)
    get_most_played(cur_most_played)

</script>
{% endblock %}